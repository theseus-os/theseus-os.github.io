<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>June/July Update: Headless Operation on seL4 | Theseus OS Blog</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="description" content="Theseus OS Blog">
    



<!-- styles -->
<link rel="stylesheet" href="/styles/vendor.css"/>
<link rel="stylesheet" href="/styles/fonts.css"/>
<link rel="stylesheet" href="/styles/app.css"/>
<link rel="stylesheet" href="/styles/highlight.css"/>

<!-- favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.ico">
<link rel="icon" type="image/svg+xml" href="/images/theseus_ship.svg">
<link rel="manifest" href="/images/site.webmanifest">

<meta name="msapplication-TileColor" content="#00aba9">
<meta name="theme-color" content="#ffffff">

 <!-- atom -->
 <link type="application/atom+xml" rel="alternate" href="https://theseus-os.github.io/blog/feed.xml" title="Theseus OS Blog" />

  </head>
  <body>
    <nav class="flex flex-row justify-center justify-end-l items-center flex-wrap ph2 pl3-ns pr4-ns">
  <div class="brand flex-auto w-100 w-auto-l self-start tc tl-l">
    <a href="/">
      <img class="v-mid ml0-l" alt="Theseus OS Logo" src="/images/theseus_ship.jpg">
      <span style="font-weight: 100;" class="dib ml1 ml0-l">Theseus OS Blog</span>
    </a>
  </div>

  <ul class="nav list w-100 w-auto-l flex flex-none flex-row flex-wrap justify-center justify-end-l items-center pv2 ph0 ph4-ns">
    <li class="tc pv2 ph2 ph4-ns flex-20-s"><a href="https://github.com/theseus-os/Theseus">Theseus OS</a></li>
    <li class="tc pv2 ph2 ph4-ns flex-20-s"><a href="https://theseus-os.github.io/Theseus/book/index.html">Theseus Book</a></li>
    <li class="tc pv2 ph2 ph4-ns flex-20-s"><a href="https://theseus-os.github.io/Theseus/doc/___Theseus_Crates___/index.html">Source Docs</a></li>
    <li class="tc pv2 ph2 ph4-ns flex-20-s"><a href="https://github.com/sponsors/kevinaboos">Sponsor Us</a></li>
    <li class="tc pv2 ph2 ph4-ns flex-20-s"><a href="mailto:theseus.systems@gmail.com?subject=Interested in Theseus OS!">Email</a></li>
  </ul>
</nav>

<section id="June/July Update: Headless Operation on seL4" class="white">
  <div class="w-100 mw-none ph3 mw8-m mw8-l center f3">
    <header>
      <h2>June/July Update: Headless Operation on seL4</h2>
      <div class="highlight mt2 mb3"></div>
    </header>

    <div class="publish-date-author">Aug. 2, 2021 &middot; Kevin Boos
    
    </div>

    <div class="post">
      <h2><a href="#one-very-busy-very-hot-summer" aria-hidden="true" class="anchor" id="one-very-busy-very-hot-summer"></a>One Very Busy, Very Hot Summer</h2>
<p>In June of this year, the Seattle area hit record high temperatures of over 110°F (44°C) for three days. Ouch!</p>
<p>We began this hot summer with the goal of enabling Theseus to run atop seL4, using both its hypervisor and VMM functionality to present Theseus with a standard &quot;bare metal&quot; x86 environment.
Unfortunately, we quickly discovered that while <a href="https://docs.sel4.systems/Tutorials/camkes-vm-linux.html">seL4 supports ARM and x86</a>, it does not yet fully support x86_64 VMMs, which is the only architecture that Theseus currently runs on.
The implementation of an x86_64 VMM was supposedly [completed by Dornerworks[(https://dornerworks.com/blog/64-bit-x86-architecture-on-sel4/)], but we were unable to get it to successfully run any x86_64 guest OS (but x86 VMs did work properly).
We have decided to postpone this particular effort until <a href="https://github.com/seL4/seL4/pull/324">this PR</a> that officially adds support for x86_64 VMMs on seL4 is accepted.</p>
<h2><a href="#headless-operation" aria-hidden="true" class="anchor" id="headless-operation"></a>Headless operation</h2>
<p>In the meantime, we started working towards Theseus-level support for <em>headless</em> operation over a serial port interface.
The serial port is the only form of direct interactive access to guest VMs on seL4 (excluding network access), so it is a necessary component to debug and use Theseus therein.
It's also useful for communicating with serial devices on other more limited platforms, e.g., our <a href="https://github.com/theseus-os/Theseus/pull/361">WIP port of Theseus to ARM Cortex-M4 microcontrollers</a>.</p>
<p>Previously, Theseus had two problems in this area:</p>
<ol>
<li>All input to the shell/terminal was assumed to come from a real keyboard and mouse.</li>
<li>The serial port was only used for basic logging output (not treated as a regular I/O device).</li>
</ol>
<p>To achieve headless operation, we had to set two corresponding goals:</p>
<ol>
<li>Abstract the terminal and input handling to work with any I/O source, not just a physical keyboard.</li>
<li>Enable full, bidirectional, arbitrary I/O across serial ports.</li>
</ol>
<h3><a href="#new-io-abstractions--stateless-vs-stateful" aria-hidden="true" class="anchor" id="new-io-abstractions--stateless-vs-stateful"></a>New I/O Abstractions:  Stateless vs. Stateful</h3>
<p>As the first step towards these goals, we created <a href="https://github.com/theseus-os/Theseus/blob/051e52782658a3e0f11c486d8656e71da1f7ba07/kernel/io/src/lib.rs">several new I/O traits</a> to represent different categories of I/O.</p>
<ul>
<li>The <a href="https://www.theseus-os.com/Theseus/doc/io/trait.BlockReader.html"><code>BlockReader</code></a> and <a href="https://www.theseus-os.com/Theseus/doc/io/trait.BlockWriter.html"><code>BlockWriter</code></a> traits represent I/O streams which can be read from or written to at the granularity of a single block (as the smallest transferable chunk).</li>
<li><a href="https://www.theseus-os.com/Theseus/doc/io/trait.BlockIo.html"><code>BlockIo</code></a> is a &quot;parent&quot; trait that specifies the size in bytes of each block
in a block-based I/O stream.</li>
<li><a href="https://www.theseus-os.com/Theseus/doc/io/trait.KnownLength.html"><code>KnownLength</code></a>: a separate trait that represents an I/O stream with a known length, such as a disk drive.</li>
<li><a href="https://www.theseus-os.com/Theseus/doc/io/trait.ByteReader.html"><code>ByteReader</code></a>, <a href="https://www.theseus-os.com/Theseus/doc/io/trait.ByteWriter.html"><code>ByteWriter</code></a>: traits that represent I/O streams which can be read from or written to at the granularity of an individual byte.</li>
<li>We also provide wrapper types that allow byte-wise access atop block-based I/O streams: <a href="https://www.theseus-os.com/Theseus/doc/io/struct.ByteReaderWrapper.html"><code>ByteReaderWrapper</code></a>, <a href="https://www.theseus-os.com/Theseus/doc/io/struct.ByteWriterWrapper.html"><code>ByteWriterWrapper</code></a>, <a href="https://www.theseus-os.com/Theseus/doc/io/struct.ByteReaderWriterWrapper.html"><code>ByteReaderWriterWrapper</code></a>.
<ul>
<li>The <a href="https://www.theseus-os.com/Theseus/doc/io/fn.blocks_from_bytes.html"><code>blocks_from_bytes()</code></a> function is useful for calculating the set of block-based I/O transfers that are needed to satisfy an arbitrary byte-wise transfer.</li>
</ul>
</li>
</ul>
<p>Notably, these traits all offer <em><strong>stateless</strong></em> access to byte streams only, an important behavioral characteristic that helps simplify state management in Theseus.
This means that they don't keep track of an internal offset within the stream.</p>
<p>For example, the <code>ByteReader</code> trait exposes only one function that requires the caller to specify at which offset the stream read should start.</p>
<pre><code class="language-rust">fn read_at(&amp;mut self, buffer: &amp;mut [u8], offset: usize) -&gt; Result&lt;...&gt;
</code></pre>
<p>These traits and types also <em>stack</em> on top of each other, e.g., you can use a <code>ByteReader</code> to realize byte-wise access to an underlying block-based I/O device that implements <code>BlockReader</code>.
We make this easier with trait <em>delegation</em>, in which wrapper types &quot;forward&quot; the trait implementation through:</p>
<ul>
<li>References (<code>&amp;dyn ByteReader</code>)</li>
<li>Mutable References (<code>&amp;mut dyn ByteReader</code>)</li>
<li>Locks (<code>Mutex&lt;ByteReader&gt;</code>) using the <a href="https://www.theseus-os.com/Theseus/doc/io/struct.LockableIo.html"><code>LockableIo</code></a> type</li>
</ul>
<p>We also offer <em><strong>stateful</strong></em> I/O types, which wrap stateless I/O streams (the above traits) to track the current offset into the I/O stream while reading or writing it.
This is similar to classic POSIX I/O interfaces, but are strongly-typed and allow for limited permissions: <a href="https://www.theseus-os.com/Theseus/doc/io/struct.ReaderWriter.html"><code>ReaderWriter</code></a>, <a href="https://www.theseus-os.com/Theseus/doc/io/struct.Reader.html"><code>Reader</code></a>, and <a href="https://www.theseus-os.com/Theseus/doc/io/struct.Writer.html"><code>Writer</code></a> structs.</p>
<p>Finally, all of the above types and traits implement the <code>no_std</code> version of <code>std::io::Read</code>/<code>Write</code> traits, which can come from crates like <a href="https://crates.io/crates/core_io"><code>core_io</code></a> or <a href="https://crates.io/crates/bare-io"><code>bare_io</code></a>.
This widely expands their compatibility to work with pretty much any other I/O-related code in the Rust ecosystem.</p>
<p>For example, we used these new I/O abstractions to integrate the <a href="https://github.com/rafalh/rust-fatfs"><code>fatfs</code> Rust crate</a> with Theseus, which allows Theseus to read and write the contents of a FAT filesystem on disk.
More work is required to provide a more generic file abstraction that can represent arbitrary files across any filesystem type, as Theseus's current representation of files is quite ad-hoc and limited to in-memory filesystems.</p>
<h3><a href="#redesigned-serial-port-driver" aria-hidden="true" class="anchor" id="redesigned-serial-port-driver"></a>Redesigned Serial Port Driver</h3>
<p>With redesigned I/O traits, we can proceed to our second goal of improving the serial port driver.</p>
<p>On x86 machines, there are up to 4 serial ports, but commonly only one or two are available: <code>COM1</code> and <code>COM2</code>.
The OS can interact with them using different I/O ports, e.g., writing bytes to <code>0x3F8</code> and the subsequent 7 port addresses will allow you to communicate with the <code>COM1</code> serial port.
Here are three great resources for learning more about serial port behavior and how to write a proper driver: <a href="https://en.wikibooks.org/wiki/Serial_Programming/8250_UART_Programming">one</a>, <a href="https://tldp.org/HOWTO/Modem-HOWTO-4.html">two</a>, <a href="https://wiki.osdev.org/Serial_Ports">three</a>.</p>
<p>The changes we needed to make are:</p>
<ul>
<li>
<p>Implement and activate interrupt handlers for all serial ports, such that the hardware triggers an interrupt when input bytes are received on the port.</p>
</li>
<li>
<p><code>SerialPort</code> instances are no longer exclusively owned by the logger, as they must be accessible from within the serial port interrupt handler and other kernel/application crates.</p>
</li>
<li>
<p>Implement the necessary read and write I/O traits for the <code>SerialPort</code> type, so we can use them in all I/O stream contexts.</p>
</li>
</ul>
<p>With these changes in place, Theseus is now able to read from and write to serial ports freely, as if it were any other I/O stream like a file or disk.</p>
<h2><a href="#other-improvements-to-theseus" aria-hidden="true" class="anchor" id="other-improvements-to-theseus"></a>Other Improvements to Theseus</h2>
<ul>
<li>
<p>Updated Theseus's Rust compiler to version 1.54, which entailed <a href="https://github.com/theseus-os/Theseus/commit/b7d62ee0197347b651e2cf1387f83c9c4a598633">many changes</a>:</p>
<ul>
<li>Refactoring all inline assembly to Rust's new <code>asm!()</code> syntax.</li>
<li>Complying with the restrictions on naked functions: Rust ABI is no longer allowed, and only one assembly block is permitted per naked function.</li>
<li>Use the new <a href="https://doc.rust-lang.org/stable/core/sync/atomic/struct.AtomicUsize.html#method.compare_exchange_weak"><code>compare_exchange_weak()</code></a> family of functions, which is more efficient on some architectures (ARM) because it is allowed to spuriously fail.</li>
</ul>
</li>
<li>
<p>Refactored code for memory-related types to unify their APIs:</p>
<ul>
<li><a href="https://github.com/theseus-os/Theseus/pull/417"><code>VirtualAddress</code> and <code>PhysicalAddress</code></a></li>
<li><a href="https://github.com/theseus-os/Theseus/commit/6854306a8f2c16f3caf1332120856a0fff8de25f"><code>Page</code> and <code>Frame</code></a></li>
<li><a href="https://github.com/theseus-os/Theseus/commit/b09ad9bc73683397a0b16b9b53f9214bdf87c04d"><code>PageRange</code> and <code>FrameRange</code></a></li>
</ul>
</li>
<li>
<p>Book documentation: thanks to <a href="https://github.com/apogeeoak">@apogeeoak</a>, the Theseus Book now has clearer structure, automatic spell check, and is built and published online via GitHub Actions CI workflows.</p>
</li>
<li>
<p>Mellanox 100GiB NIC: <a href="https://github.com/Ramla-I">Ramla Ijaz</a> added basic support for <a href="https://github.com/theseus-os/Theseus/pull/404">initializing and configuring this high-performance NIC</a>. Packet transmission is an ongoing work in progress.</p>
</li>
<li>
<p>Added support for parsing the ACPI <code>DMAR</code> table, which specifies details about the system's IOMMU.</p>
<ul>
<li>This is part of our quest to protect Theseus's single address space execution environment from errant or malicious I/O devices that attempt to access arbitrary system memory without permission, the one final frontier in the &quot;chain of safety&quot; that cannot be checking by the compiler.</li>
</ul>
</li>
</ul>
<h2><a href="#contributions-to-other-open-source-projects" aria-hidden="true" class="anchor" id="contributions-to-other-open-source-projects"></a>Contributions to other Open-Source Projects</h2>
<ul>
<li>We added <a href="https://github.com/rafalh/rust-fatfs/pull/44">compile-time configuration of logging flexibility</a> to the <code>rust-fatfs</code> crate.</li>
<li>We ported the MPMC Queue crate to <a href="https://github.com/brayniac/mpmc/pull/8">support <code>no_std</code> environments</a> on the latest version of Rust.</li>
</ul>
<h2><a href="#next-steps" aria-hidden="true" class="anchor" id="next-steps"></a>Next Steps</h2>
<p>Now that we have flexible, generic I/O abstractions available in Theseus, the next step for achieving full headless operation is to enable a terminal/CLI to handle I/O to and from arbitrary sources, such as a serial port.</p>

    </div>
  </div>
</section>

    <footer>
  <div class="w-100 mw-none ph3 mw8-m mw9-l center f3">
    <div class="row">
      <div class="four columns mt3 mt0-l" id="get-help">
        <h4>More info</h4>
        <ul>
          <li><a href="https://github.com/theseus-os/Theseus/">Theseus OS on GitHub</a></li>
          <li><a href="https://github.com/theseus-os/">Theseus OS Organization</a></li>
          <li><a href="mailto:theseus.systems@gmail.com">Contact Us</a></li>
        </ul>
      </div>
      <div class="four columns mt3 mt0-l">
        <h4>Terms and policies</h4>
        <ul>
          <li><a href="https://www.rust-lang.org/policies/code-of-conduct">Rust's Code of Conduct</a></li>
          <li>Licenses:  <a href="https://opensource.org/licenses/MIT">MIT</a>  <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0</a></li>
          <li><a href="https://github.com/rust-lang/blog.rust-lang.org">Based on Rust's Blog Format</a></li>
        </ul>
      </div>
      <div class="four columns mt3 mt0-l">
        <h4>Social</h4>
        <div class="flex flex-row flex-wrap">
          <a href="https://twitter.com/rustlang" target="_blank" rel="noopener" alt="twitter link"><img src="/images/twitter.svg" alt="twitter logo" title="Twitter"/></a>
          <a href="https://www.youtube.com/channel/UCaYhcUwRBNscFNUKTjgPFiA" target="_blank" rel="noopener" alt="youtube link"><img style="padding-top: 6px; padding-bottom:6px" src="/images/youtube.svg" alt="youtube logo" title="YouTube"/></a>
          <a href="https://discord.gg/rust-lang" target="_blank" rel="noopener" alt="discord link"><img src="/images/discord.svg" alt="discord logo" title="Discord"/></a>
          <a href="https://github.com/rust-lang" target="_blank" rel="noopener" alt="github link"><img src="/images/github.svg" alt="github logo" title="GitHub"/></a>
        </div>
        <h4 class="mt4 mb3">RSS</h4>
        <ul>
          <li><a href="/feed.xml">Theseus Blog RSS Feed</a></li>
        </ul>
      </div>

    </div>
    <div class="attribution">
      Maintained by the Theseus OS organization. See a typo?
      <a href="https://github.com/theseus-os/blog" target="_blank" rel="noopener">File an issue here</a>!
    </div>
  </div>
</footer>

<!-- scripts -->
<script src="/scripts/highlight.js"></script>

  </body>
</html>
